<!DOCTYPE html>
 <html lang="en">
	<head>
		<style type="text/css">
			#detailViewContainer {
				border: solid 1px green;
				float: left;
			}
			
			#detailView {
				border: solid 1px red;
				height: 240px;
				width: 320px;
				float: left;
				margin-left: 20px;
			}
			
			#contextView {
				border: solid 1px red;
				height: 240px;
				width: 320px;
				float: left;
/*				margin: 10px;
				padding: 10px; */
			}
			
			.area {
			  fill: steelblue;
			  clip-path: url(#clip);
			}

			.axis path,
			.axis line {
			  fill: none;
			  stroke: #000;
			  shape-rendering: crispEdges;
			}

			.brush .extent {
			  stroke: #fff;
			  fill-opacity: .125;
			  shape-rendering: crispEdges;
			}
		</style>
	</head>
	<body>
		<p id="#output">ho</p>
		
		<div id="detailViewContainer">
			<div id="detailView">
				<p>Hi</p>
			</div>
			
		<br />
		<hr />
		<p>Input</p>
		<form>
		  <input type="date" id="startTime" value="2009-04-01" min="" max=""><br>
		  <input type="date" id="endTime" value="2009-05-01" min="" max=""><br>
		  yes_rsvp_count less than:
		  <input id="yes_rsvp_countLess" type="range" value="50" min="0" max="500" step="1" oninput="document.querySelector('#yes_rsvp_countLessLabel').innerHTML = value" />
		  <output for="yes_rsvp_countLess" id="yes_rsvp_countLessLabel">50</output>
		  <br />
		  yes_rsvp_count more than:
		  <input id="yes_rsvp_countMore" type="range" value="50" min="0" max="500" step="1" oninput="document.querySelector('#yes_rsvp_countMoreLabel').innerHTML = value" />
		  <output for="yes_rsvp_countMore" id="yes_rsvp_countMoreLabel">50</output>
		  <p><a href="#" onClick='doDetailView()'>Update</a></p>
		</form>
			
		</div>
		

		<div id="contextView">
		
		</div>
		
		<script src="http://d3js.org/d3.v3.min.js"></script>
		<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.3.min.js"> </script>
		<script>
			
			var contextStartDate = new Date("2009-01-01")
			var contextEndDate = new Date("2010-01-01")
			console.log(contextStartDate)
						
			doContextView()
			
			function doDetailView() {
				var width = parseInt($("#detailView").css("width"));
				var height = parseInt($("#detailView").css("height"));
				
				var startTime = document.getElementById("startTime").valueAsDate;
				var endTime = document.getElementById("endTime").valueAsDate;
				
				//d3.select("#detailView").remove();
				$("#detailView").empty()
				
				var svg = d3.select("#detailView")
					.append("svg")
						.attr("width", width)
						.attr("height", height)
				
				//document.querySelector('#startTime')
				
				var xScale = d3.scale.linear()
					.domain([startTime, endTime])
					.range([0, width])
				
				var yScale = d3.scale.linear()
					.domain([0, 40])
					.range([0, height])
				
				color = d3.scale.ordinal()
					.range(["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2"])
					.domain([0,1,2,3,4,5,6])
				
				d3.json(
				"/groups/?" +
				"limit=150" + "&startTime="+ startTime +
				"&endTime=" + endTime
				,
					function(err, data) {
						if(err) {
							console.warn("ERROR");
							console.warn(err);
							return;
						}
						console.log(data)
						
						svg.selectAll("circle")
							.data(data)
								.enter()
									.append("circle")
										.attr("r", "5")
										.attr("fill", function(d) { return color(d.group.category.name) })
										.attr("cx", function(d) {return xScale(d.time) })
										.attr("cy", function(d) {return yScale(d.yes_rsvp_count + 5) })
					}
				)
			}
			
			function doContextView() {
				
				
				
				var	contextView = document.querySelector('contextView');
			
				var top = parseInt($("#contextView").css("top"));
				var left = 0;
				//var left = $("#contextView").css("left")
				//console.log(left);
			
				var width = parseInt($("#contextView").css("width"));
				var height = parseInt($("#contextView").css("height"));
			
			
				// The domain can be different here.
				// Right now, just a direct mapping of pixels to pixels
				/*
				var	xScale = d3.scale.linear()
					.domain([0, width])
					.range([0, width])
				*/
				
				var xScale = d3.time.scale()
					.domain([contextStartDate, contextEndDate])
					.range([0, width])
				
				var yScale = d3.scale.linear()
					.domain([0, 500])
					.range([height, 0])
				/*
				var	yScale = d3.scale.linear()
					.domain([0, height])
					.range([0, height])
				*/
				
				var brush = d3.svg.brush()
					.x(xScale)
					.y(yScale)
					.on("brush", brushed);

				var contextSvg = d3.select("#contextView").append("svg")
					.attr("width", width)
					.attr("height", height);

				  contextSvg.append("g")
					  .attr("class", "brush")
					  .call(brush)
					.selectAll("rect")
			
			
				// Axis
				var	xAxis = d3.svg.axis().scale(xScale).orient("bottom")
			
				contextSvg.append("g")
				  .attr("class", "x axis")
				  .call(xAxis)
			
				var	yAxis = d3.svg.axis().scale(yScale).orient("left")
			
				contextSvg.append("g")
					.attr("class", "y axis")
					.call(yAxis)
			
				function brushed() {
				  var extent = brush.extent();
  
				  var output = document.getElementById("#output");
  
				  output.innerHTML = ""
				  output.innerHTML += "X1: " + extent[0][0]
				  output.innerHTML += "<br />"
				  output.innerHTML += "Y1: " + extent[0][1]
				  output.innerHTML += "<br />"
				  output.innerHTML += "X2: " + extent[1][0]
				  output.innerHTML += "<br />"
				  output.innerHTML += "Y2: " + extent[1][1]
				  output.innerHTML += "<br />"
				  
				  // Extracting the time into YYYY-MM-DD that the field will accept
				  
				  // Setting start time field
				  var startTimeInput = document.querySelector('#startTime')
				  
				  var newTime = "";
				  newTime += extent[0][0].getFullYear()
				  newTime += "-"
				  newTime += String('0' + (parseInt(extent[0][0].getMonth())+1).toString()).slice(-2)
				  newTime += "-"
				  newTime += String('0' + extent[0][0].getDate()).slice(-2)

				  startTimeInput.value = newTime
				  
				  
				  // Setting end time field
				  var endTimeInput = document.querySelector('#endTime')
				  
				  newTime = "";
				  newTime += extent[1][0].getFullYear()
				  newTime += "-"
				  newTime += String('0' + (parseInt(extent[1][0].getMonth())+1).toString()).slice(-2)
				  newTime += "-"
				  newTime += String('0' + extent[1][0].getDate()).slice(-2)
				  
				  endTimeInput.value = newTime
				  
				  // For #yes_rsvp_countLess
				  
				  // TODO Maybe round to int?
				  
				  var yes_rsvp_countLessInput = document.querySelector('#yes_rsvp_countLess')
				  yes_rsvp_countLessInput.value = parseInt(extent[0][1])
				  document.querySelector('#yes_rsvp_countLessLabel').innerHTML = parseInt(extent[0][1])
				  
				  var yes_rsvp_countMoreInput = document.querySelector('#yes_rsvp_countMore')
				  yes_rsvp_countMoreInput.value = parseInt(extent[1][1])
				  document.querySelector('#yes_rsvp_countMoreLabel').innerHTML = parseInt(extent[1][1])
				}
			}

	</script>

	</body>
 </html>
 